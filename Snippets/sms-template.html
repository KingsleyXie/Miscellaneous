<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<title>短信批量生成工具</title>
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
</head>

<body>
	<br><h1 class="text-center">短信批量生成工具</h1><br><br><br>

	<input type="file" class="file" id="file" name="file">

	<br><br><br>

	<div class="container-fluid">
		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4><b>收信人手机号</b>对应的数据列是：</h4>
			</div>

			<div class="col-md-4">
				<select class="selectpicker show-tick" id="select"
					title="请选择"
					data-width="100%"
					data-live-search="true">
					<option></option>
				</select>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4>请在右侧输入短信模板：</h4>
			</div>

			<div class="col-md-4">
				<textarea class="form-control" rows="3"></textarea>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-5 col-md-2">
				<button type="button" class="btn btn-info">添加数据列到模板</button>
			</div>

			<div class="col-md-2 text-right">
				<button type="button" class="btn btn-default">预览短信效果</button>
				<button type="button" class="btn btn-primary">生成所有短信</button>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/sortable.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/purify.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.0.0/popper.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/locales/zh.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/xlsx/0.8.1/xlsx.core.min.js"></script>

	<script>
		// = =! You had to use jQuery here
		$("#file").fileinput({
			theme: 'explorer',
			language: 'zh',
			browseLabel: '浏览',
			msgPlaceholder: '点击右侧按钮上传 👉',
			dropZoneTitle:
				'<p>请上传 Excel 文件后选取数据列并输入短信模板</p>' +
				'<p><strong>点击右下角浏览按钮选择文件</strong>' +
				'或 <strong>直接将文件拖拽到这里</strong></p>',
			showUpload: false,
			allowedFileExtensions: ['xls', 'xlsx'],
			maxFileSize: 500000,
			maxFileCount: 1,
			previewFileExtSettings: {
				'xls': function(ext) { return ext.match(/(xls|xlsx)$/i); }
			}
		});

		// = =! You had to use jQuery here again
		// $('.selectpicker').selectpicker('hide');

		let worksheet = null, columnNames = [];
		document.getElementById('file')
		.addEventListener('input', (e) => {
			var reader = new FileReader();
			reader.onload = (e) => {
				var data = e.target.result;
				var workbook = XLSX.read(data, {type: 'binary'});
				worksheet = workbook.Sheets[workbook.SheetNames[0]];

				var columns = XLSX.utils.decode_range(worksheet['!ref']).e.c;
				var startRow = 0;

				// Check if there is a title row by where the last column of first row is set
				var finalCellPos = XLSX.utils.encode_cell({c: columns, r: 0});
				// var finalCellPos = worksheet['!ref'].replace(/.*:([A-Za-z]*)\d*/, '$1') + '1';
				if (worksheet[finalCellPos] == undefined) startRow++;

				// = =! You had to use jQuery here again and again
				$('.selectpicker').selectpicker('show');

				document.getElementById('select').innerHTML = '';
				columnNames = [];

				for (var col = 0; col <= columns; col++) {
					var pos = XLSX.utils.encode_cell({c: col, r: startRow});

					var option = document.createElement("option");
					option.text = worksheet[pos].w;
					document.getElementById('select').add(option);
					columnNames.push(option.text);
				}
				// = =! You had to use jQuery here again and again and again
				$('.selectpicker').selectpicker('refresh');
			};
			reader.readAsBinaryString(e.target.files[0]);
		});
	</script>
</body>
</html>
