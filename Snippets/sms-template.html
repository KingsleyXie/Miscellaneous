<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<title>çŸ­ä¿¡æ‰¹é‡ç”Ÿæˆå·¥å…·</title>
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
</head>

<body>
	<br><h1 class="text-center">çŸ­ä¿¡æ‰¹é‡ç”Ÿæˆå·¥å…·</h1><br><br><br>

	<input type="file" class="file" id="file" name="file">

	<br><br><br>

	<div class="container-fluid">
		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4><b>æ”¶ä¿¡äººæ‰‹æœºå·</b>å¯¹åº”çš„æ•°æ®åˆ—æ˜¯ï¼š</h4>
			</div>

			<div class="col-md-4">
				<select class="selectpicker show-tick" id="select"
					title="è¯·é€‰æ‹©"
					data-width="100%"
					data-live-search="true">
					<option></option>
				</select>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4>è¯·åœ¨å³ä¾§è¾“å…¥çŸ­ä¿¡æ¨¡æ¿ï¼š</h4>
			</div>

			<div class="col-md-4">
				<textarea class="form-control" rows="3"></textarea>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-5 col-md-2">
				<button type="button" class="btn btn-info">æ·»åŠ æ•°æ®åˆ—åˆ°æ¨¡æ¿</button>
			</div>

			<div class="col-md-2 text-right">
				<button type="button" class="btn btn-default">é¢„è§ˆçŸ­ä¿¡æ•ˆæœ</button>
				<button type="button" class="btn btn-primary">ç”Ÿæˆæ‰€æœ‰çŸ­ä¿¡</button>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/sortable.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/purify.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.0.0/popper.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/locales/zh.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/xlsx/0.8.1/xlsx.core.min.js"></script>

	<script>
		// = =! You had to use jQuery here
		$("#file").fileinput({
			theme: 'explorer',
			language: 'zh',
			browseLabel: 'æµè§ˆ',
			msgPlaceholder: 'ç‚¹å‡»å³ä¾§æŒ‰é’®ä¸Šä¼  ğŸ‘‰',
			dropZoneTitle:
				'<p>è¯·ä¸Šä¼  Excel æ–‡ä»¶åé€‰å–æ•°æ®åˆ—å¹¶è¾“å…¥çŸ­ä¿¡æ¨¡æ¿</p>' +
				'<p><strong>ç‚¹å‡»å³ä¸‹è§’æµè§ˆæŒ‰é’®é€‰æ‹©æ–‡ä»¶</strong>' +
				'æˆ– <strong>ç›´æ¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ</strong></p>',
			showUpload: false,
			allowedFileExtensions: ['xls', 'xlsx'],
			maxFileSize: 500000,
			maxFileCount: 1,
			previewFileExtSettings: {
				'xls': function(ext) { return ext.match(/(xls|xlsx)$/i); }
			}
		});

		// = =! You had to use jQuery here again
		// $('.selectpicker').selectpicker('hide');

		let worksheet = null, columnNames = [];
		document.getElementById('file')
		.addEventListener('input', (e) => {
			var reader = new FileReader();
			reader.onload = (e) => {
				var data = e.target.result;
				var workbook = XLSX.read(data, {type: 'binary'});
				worksheet = workbook.Sheets[workbook.SheetNames[0]];

				var columns = XLSX.utils.decode_range(worksheet['!ref']).e.c;
				var startRow = 0;

				// Check if there is a title row by where the last column of first row is set
				var finalCellPos = XLSX.utils.encode_cell({c: columns, r: 0});
				// var finalCellPos = worksheet['!ref'].replace(/.*:([A-Za-z]*)\d*/, '$1') + '1';
				if (worksheet[finalCellPos] == undefined) startRow++;

				// = =! You had to use jQuery here again and again
				$('.selectpicker').selectpicker('show');

				document.getElementById('select').innerHTML = '';
				columnNames = [];

				for (var col = 0; col <= columns; col++) {
					var pos = XLSX.utils.encode_cell({c: col, r: startRow});

					var option = document.createElement("option");
					option.text = worksheet[pos].w;
					document.getElementById('select').add(option);
					columnNames.push(option.text);
				}
				// = =! You had to use jQuery here again and again and again
				$('.selectpicker').selectpicker('refresh');
			};
			reader.readAsBinaryString(e.target.files[0]);
		});
	</script>
</body>
</html>
