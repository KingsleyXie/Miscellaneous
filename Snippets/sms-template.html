<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<title>çŸ­ä¿¡æ‰¹é‡ç”Ÿæˆå·¥å…·</title>
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/css/fileinput.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.css">
	<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
</head>

<body>
	<div class="modal fade" tabindex="-1" id="data-col-modal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
					</button>
					<h5 class="modal-title text-center">æ·»åŠ æ•°æ®åˆ—</h5>
				</div>
				<div class="modal-body">
					<select class="selectpicker show-tick" id="select-column"
						title="è¯·é€‰æ‹©è¦æ·»åŠ çš„åˆ—å"
						data-width="100%"
						data-live-search="true">
						<option></option>
					</select>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" id="alert-modal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title text-center">ç³»ç»Ÿæç¤º</h4>
				</div>
				<h3 class="modal-body" id="modal-msg"></h3>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary center-block" data-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
				</div>
			</div>
		</div>
	</div>

	<br><h1 class="text-center">çŸ­ä¿¡æ‰¹é‡ç”Ÿæˆå·¥å…·</h1><br><br><br>

	<input type="file" class="file" id="file" name="file">

	<br><br><br>

	<div class="container-fluid" id="operations">
		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4><b>æ”¶ä¿¡äººæ‰‹æœºå·</b>å¯¹åº”çš„æ•°æ®åˆ—æ˜¯ï¼š</h4>
			</div>

			<div class="col-md-4">
				<select class="selectpicker show-tick" id="select-phone"
					title="è¯·é€‰æ‹©"
					data-width="100%"
					data-live-search="true">
					<option>wtf</option>
				</select>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<h4>è¯·åœ¨å³ä¾§è¾“å…¥çŸ­ä¿¡æ¨¡æ¿ï¼š</h4>
			</div>

			<div class="col-md-4">
				<textarea class="form-control" id="textarea" rows="3"></textarea>
			</div>
		</div>

		<br>

		<div class="row">
			<div class="col-md-offset-3 col-md-2">
				<button type="button" class="btn btn-primary">ç”Ÿæˆå¹¶å¯¼å‡ºæ‰€æœ‰çŸ­ä¿¡</button>
			</div>

			<div class="col-md-4 text-right">
				<button type="button" class="btn btn-info"
					data-toggle="modal" data-target="#data-col-modal">æ·»åŠ æ•°æ®åˆ—åˆ°æ¨¡æ¿</button>
				<button type="button" class="btn btn-default">é¢„è§ˆçŸ­ä¿¡æ•ˆæœ</button>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/piexif.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/sortable.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/plugins/purify.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.0.0/popper.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/fileinput.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/themes/explorer/theme.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-fileinput/4.5.1/js/locales/zh.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
	<script src="https://cdnjs.loli.net/ajax/libs/xlsx/0.8.1/xlsx.core.min.js"></script>

	<script>
		// = =! You have to use jQuery here
		$("#file").fileinput({
			theme: 'explorer',
			language: 'zh',
			browseLabel: 'æµè§ˆ',
			msgPlaceholder: 'ç‚¹å‡»å³ä¾§æŒ‰é’®ä¸Šä¼  ğŸ‘‰',
			dropZoneTitle:
				'<p>è¯·ä¸Šä¼  Excel æ–‡ä»¶åé€‰å–æ•°æ®åˆ—å¹¶è¾“å…¥çŸ­ä¿¡æ¨¡æ¿</p>' +
				'<p><strong>ç‚¹å‡»å³ä¸‹è§’æµè§ˆæŒ‰é’®é€‰æ‹©æ–‡ä»¶</strong>' +
				'æˆ– <strong>ç›´æ¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ</strong></p>',
			showUpload: false,
			allowedFileExtensions: ['xls', 'xlsx'],
			maxFileSize: 500000,
			maxFileCount: 1,
			previewFileExtSettings: {
				'xls': function(ext) { return ext.match(/(xls|xlsx)$/i); }
			}
		})

		// = =! You have to use jQuery here again
		$('#select-column').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
			var tgt = e.target;
			var middle = '{{' + tgt.value + tgt.selectedOptions[0].dataset.subtext + '}}';

			var textarea = document.getElementById("textarea");
			var firstHalf = textarea.value.substr(0, textarea.selectionStart);
			var secondHalf = textarea.value.substr(textarea.selectionEnd, textarea.value.length);

			textarea.value = firstHalf + middle + secondHalf;

			// = =! You have to use jQuery here again and again
			$("#data-col-modal").modal('hide');
		})

		document.getElementById("operations").style.display = "none";
		let worksheet = null;

		document.getElementById('file')
		.addEventListener('input', (e) => {
			var reader = new FileReader();
			reader.onload = (e) => {
				var data = e.target.result;
				var workbook = XLSX.read(data, {type: 'binary'});
				worksheet = workbook.Sheets[workbook.SheetNames[0]];

				var colRange = XLSX.utils.decode_range(worksheet['!ref']).e.c;
				var rowRange = XLSX.utils.decode_range(worksheet['!ref']).e.r;
				var headerRow = 0;

				// Get the row of header names
				while (headerRow < rowRange) {
					var finalCellPos = XLSX.utils.encode_cell({c: colRange, r: headerRow});
					if (worksheet[finalCellPos] == undefined) headerRow++;
					else break;
				}

				document.getElementById("select-phone").innerHTML = '';
				document.getElementById("select-column").innerHTML = '';

				for (var col = 0; col <= colRange; col++) {
					var pos = XLSX.utils.encode_cell({c: col, r: headerRow});

					var option = document.createElement("option");
					try {
						option.text = worksheet[pos].w;
						document.getElementById("select-phone").add(option);

						var optionWithSubtext = option.cloneNode(true);
						optionWithSubtext.dataset.subtext = 'COL' + col;
						document.getElementById("select-column").add(optionWithSubtext);
					} catch (TypeError) {
						document.getElementById("modal-msg").innerHTML = '<center>è¡¨æ ¼æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼</center>';

						// = =! You have to use jQuery here again and again and again
						$("#alert-modal").modal('show');
						break;
					}
				}

				// = =! You have to use jQuery here again and again and again and again
				$('.selectpicker').selectpicker('refresh');
				document.getElementById("operations").style.display = "block";
			};
			reader.readAsBinaryString(e.target.files[0]);
		});

	</script>
</body>
</html>
